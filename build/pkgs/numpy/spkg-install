#! /usr/bin/env bash

# From sage-spkg.
# For type=script packages, the build rule in build/make/Makefile sources
# sage-env but not sage-dist-helpers.
lib="$SAGE_ROOT/build/bin/sage-dist-helpers"
source "$lib"
if [ $? -ne 0 ]; then
    echo >&2 "Error: failed to source $lib"
    echo >&2 "Is $SAGE_ROOT the correct SAGE_ROOT?"
    exit 1
fi

git clone https://github.com/mkoeppe/numpy.git src
cd src
git fetch origin 36d41a6cf76491d4d7066329f3c6483a8428c518
git checkout 36d41a6cf76491d4d7066329f3c6483a8428c518

set -e

if [ `uname` = "Darwin" ]; then
    unset ATLAS
    unset BLAS
    unset LAPACK
else
    export {ATLAS,PTATLAS,OPENBLAS,MKL,MKLROOT}=None
    export LDFLAGS="${LDFLAGS} -shared"
fi

sage-python23 ../lapack_conf.py

# Make sure that the fortran objects are compiled with -fPIC
export FFLAGS="$FFLAGS -fPIC"
export FCFLAGS="$FCFLAGS -fPIC"

export NUMPY_FCONFIG="config_fc --noopt --noarch"

################################################

sage-python23 setup.py \
        --no-user-cfg \
       install \
       --single-version-externally-managed \
       --root "$SAGE_DESTDIR" \
       ${NUMPY_FCONFIG} || sdh_die "Error building / installing numpy"
